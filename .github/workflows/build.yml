name: Build FFmpeg Windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install system dependencies and build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autopoint \
            libglib2.0-dev \
            jq \
            cmake \
            ninja-build \
            make \
            autoconf \
            automake \
            libtool \
            pkg-config \
            texinfo \
            gettext \
            gperf \
            bison \
            flex \
            git \
            xz-utils \
            unzip \
            diffutils \
            file \
            findutils \
            coreutils \
            binutils \
            python3 \
            python3-pip \
            python3-venv \
            pipx \
            subversion \
            libtool-bin \
            nasm \
            yasm \
            mingw-w64

      - name: Set up Rust  
        uses: actions-rs/toolchain@v1  
        with:  
          toolchain: stable  
          profile: minimal  
          override: true  


      - name: Install cargo-c
        run: |
          mkdir -p $HOME/.cargo/bin
          curl -L https://github.com/lu-zero/cargo-c/releases/download/v0.10.16/cargo-c-x86_64-unknown-linux-musl.tar.gz -o /tmp/cargo-c.tar.gz
          tar -xzf /tmp/cargo-c.tar.gz -C $HOME/.cargo/bin
          chmod +x $HOME/.cargo/bin/cargo-c*
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          export PATH="$HOME/.cargo/bin:$PATH"
          cargo-cinstall --version
          

      - name: Add Rust Windows target
        run: |
          rustup target add x86_64-pc-windows-gnu

      - name: Set build environment
        run: |
          echo "ARCH=${{ matrix.arch }}" >> $GITHUB_ENV
          echo "BUILD_TARGET=windows" >> $GITHUB_ENV

      - name: Run build.sh
        run: |
          rm -rf ${{ github.workspace }}/out
          mkdir -p ${{ github.workspace }}/out
          bash ${{ github.workspace }}/build.sh
        env:
          LATEST_GIT: 1

      - name: Upload Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.arch }}
          path: ${{ github.workspace }}/out/*.exe
